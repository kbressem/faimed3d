---

title: Callbacks


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/06_callback.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/06_callback.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Channel-Manipulation">Channel Manipulation<a class="anchor-link" href="#Channel-Manipulation"> </a></h2><p>Fpr processing multiple 3D volumes, the volumes can be stacked to the color dimension. This need to be implemented as callback, before the batch is presented to the model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="StackVolumes" class="doc_header"><code>class</code> <code>StackVolumes</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/callback.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>StackVolumes</code>(<strong><code>n_classes</code></strong>, <strong><code>pool_type</code></strong>=<em><code>'max'</code></em>, <strong><code>stack_yb</code></strong>=<em><code>False</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Takes multiple 3D volumes and stacks them in the color dim.
This is usefull when using mutli-sequence medical data.</p>
<p>Can also merge multiple segmentation masks, through pooling (max, min or mean) alongside the color dim,
then convertes the mask to one-hot encoded type. However, this can lead to 'ugly' masks with punch-out like
appearences</p>
<p>Example:
    Having the Tensors of size (10, 1, 5, 25, 25) would lead to a single Tensor of
    size (10, 3, 5, 25, 25).</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Callbacks-for-Volume-Manipulation">Callbacks for Volume Manipulation<a class="anchor-link" href="#Callbacks-for-Volume-Manipulation"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In medical imaging, small regions in the image are often decisive for the diagnosis. This means, given a smaller subregion of the image, the model could still correctly detect the pathology. Through splitting the volumes the data might thus be augmented.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SplitVolumes" class="doc_header"><code>class</code> <code>SplitVolumes</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/callback.py#L61" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SplitVolumes</code>(<strong><code>n_subvol</code></strong>=<em><code>8</code></em>, <strong><code>split_along_depth</code></strong>=<em><code>True</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Separates a 3D tensor into smaller equal sized subvolumes.</p>
<p>o---o---o       o---o---o
 | A | A |       | B | B |        o---o  o---o  o---o  o---o  o---o  o---o  o---o  o---o
 o---o---o   +   o---o---o  ==&gt;   | A | +| A | +| B | +| B | +| A | +| A | +| B | +| B |
 | A | A |       | B | B |        o---o  o---o  o---o  o---o  o---o  o---o  o---o  o---o
 o---o---o       o---o---o</p>
<p>Args:
    n_subvol = number of subvolumes
    split_along_depth = whether volumes should also be split along the D dimension fpr a [B, C, D, H, W] tensor</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Subsampling the subvolumes allows for more variability in the image and also training with a batch size &lt; 1.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SubsampleShuffle" class="doc_header"><code>class</code> <code>SubsampleShuffle</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/callback.py#L123" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SubsampleShuffle</code>(<strong><code>p</code></strong>=<em><code>0.5</code></em>, <strong><code>n_subvol</code></strong>=<em><code>8</code></em>, <strong><code>split_along_depth</code></strong>=<em><code>True</code></em>) :: <a href="/faimed3d/callback.html#SplitVolumes"><code>SplitVolumes</code></a></p>
</blockquote>
<p>After splitting rhe volume into multiple subvolumes, draws a radnom amount of subvolumes for training.
Would allow to train on an effective batch size &lt; 1.</p>
<p>o---o---o        o---o---o
| A | A |        | B | B |        o---o  o---o  o---o  o---o  o---o  o---o
o---o---o    +   o---o---o  ==&gt;   | B | +| A | +| A | +| A | +| B | +| A |
| A | A |        | B | B |        o---o  o---o  o---o  o---o  o---o  o---o
o---o---o        o---o---o</p>
<p>Args:
    p: percentage of subvolumes to train on</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Assuming, a small finding is predominantly located in the, e.g. upper left image region, the model might wrongly learn the location as an important factor for the finding. Mixing subvolumes might help.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MixSubvol" class="doc_header"><code>class</code> <code>MixSubvol</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/callback.py#L163" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MixSubvol</code>(<strong><code>p</code></strong>=<em><code>0.25</code></em>, <strong><code>n_subvol</code></strong>=<em><code>8</code></em>, <strong><code>split_along_depth</code></strong>=<em><code>True</code></em>) :: <a href="/faimed3d/callback.html#SplitVolumes"><code>SplitVolumes</code></a></p>
</blockquote>
<p>After splitting rhe volume into multiple subvolumes, shuffels the subvolumes and sticks the images back together.</p>
<p>o---o---o        o---o---o        o---o---o        o---o---o
| A | A |        | B | B |        | B | B |        | A | B |
o---o---o    +   o---o---o  ==&gt;   o---o---o    +   o---o---o
| A | A |        | B | B |        | A | A |        | B | A |
o---o---o        o---o---o        o---o---o        o---o---o</p>
<p>Args:
    p: probability that the callback will be applied
    n_subvol: number of subvolumina to create
    split_along_depth: whether the depth dimension should be included</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Implementation for MicUp on 3D data</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MixUp3D" class="doc_header"><code>class</code> <code>MixUp3D</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/callback.py#L200" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MixUp3D</code>(<strong><code>p</code></strong>=<em><code>0.5</code></em>) :: <code>Callback</code></p>
</blockquote>
<p>Implementation of MixUp for 3D images.
Note that the loss function does not need to be adapted like in fastais MixUp, as MCC and DICE loss accept float values.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tracker-Callbacks">Tracker Callbacks<a class="anchor-link" href="#Tracker-Callbacks"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ReloadBestFit" class="doc_header"><code>class</code> <code>ReloadBestFit</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/callback.py#L223" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ReloadBestFit</code>(<strong><code>fname</code></strong>, <strong><code>monitor</code></strong>=<em><code>'valid_loss'</code></em>, <strong><code>comp</code></strong>=<em><code>None</code></em>, <strong><code>min_delta</code></strong>=<em><code>0.0</code></em>, <strong><code>patience</code></strong>=<em><code>1</code></em>) :: <code>TrackerCallback</code></p>
</blockquote>
<p>A <code>TrackerCallback</code> that reloads the previous best model if not improvement happend for n epochs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

