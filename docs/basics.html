---

title: Basics


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/01_basics.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_basics.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Why-a-new-Class?">Why a new Class?<a class="anchor-link" href="#Why-a-new-Class?"> </a></h2><p>Fastai 2 provides support to read and display medical images using pydicom and pillow, however only 2D images can be read. So no direct support of 3D volumes is given in fastai. Furthermore, fastai only allows to read DICOM 2D images, not volumes, DICOM Series or any of the other medical formats such as NIfTI, NRRD, ....  For effective work with medical data, all possible formats should be supported. Therefore, in <code>faimed3d</code> <a href="https://simpleitk.org/">SimpleITK</a>  is used to read images. SimpleITK is a powerfull library which can handle many data formats, including all of the above mentioned and many more. It is widely used for medical applications and very fast, as it is written in pure C++.<br>
To allow specific augmentations, only to 3D data, two new classes are used in <code>faimed3d</code>: <a href="/faimed3d/basics.html#TensorDicom3D"><code>TensorDicom3D</code></a> for 3D image volumes and <a href="/faimed3d/basics.html#TensorMask3D"><code>TensorMask3D</code></a> for segmentation masks. Both are subclasses to <code>torch.Tensor</code>. A basic support for Header information will be implemented in both classes, as the header sometimes has important information, e.g. for re-scaling of the pixel values, pixel spacing or patient orientation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Reading-medical-files-with-TensorDicom3D">Reading medical files with TensorDicom3D<a class="anchor-link" href="#Reading-medical-files-with-TensorDicom3D"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TensorDicom3D" class="doc_header"><code>class</code> <code>TensorDicom3D</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TensorDicom3D</code>(<strong><code>x</code></strong>, <strong><code>metadata</code></strong>=<em><code>None</code></em>, <strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>TensorBase</code></p>
</blockquote>
<p>Base class for 3D medical images</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}
class TensorDicom3D(Tensor):
    "Base class for 3D medical images"
      
    def __init__(self, data, metadata=None, **kwargs):
        self._t = torch.as_tensor(data, **kwargs)
        if metadata is None: 
            metadata =  {'0008|103E': ['faimed3d TensorDicom3D, pixeldata might have been modified'], 
                         'filename': [''],
                         'spacing' : [(1,1,1)], 
                         'origin' : [(0,0,0)],
                         'direction' : [(1,0,0, 0,1,0, 0,0,1) ]    
                        }
        self._metadata =  metadata

    def __repr__(self): 
        return str(self._t)
    
    @staticmethod
    def __new__(cls, data, metadata=None, *args, **kwargs):
        return super().__new__(cls, data, *args, **kwargs)
       
    def __torch_function__(self, func, types, args=(), kwargs=None):
        if kwargs is None:
            kwargs = {}
        args = [a._t if hasattr(a, '_t') else a for a in args]
        ret = func(*args, **kwargs)
        new = TensorDicom3D([], metadata=self._metadata)
        new._t = ret
        return new
   
    def __getitem__(self, item: torch.Tensor):
        updated_value = self._t[item]
        return TensorDicom3D(updated_value, self._metadata)   
    
    def to(self, *args, **kwargs):
        new_obj = TensorDicom3D([], self._metadata)
        tempTensor=super().to(*args, **kwargs)
        new_obj.data=tempTensor.data
        new_obj.requires_grad=tempTensor.requires_grad
        return(new_obj)
    
    def clone(self, *args, **kwargs): 
        return TensorDicom3D(super().clone(*args, **kwargs), self._metadata)    
    
    @classmethod
    def create(cls, fn:(Path,str,Tensor,ndarray), load_header=False,  **kwargs):
        """
        Open an `3D Image` from path `fn` or create it from an array
        Args: 
            cls: Class of the object to create. Should be either TensorDicom3D or TensorMask3D
            fn:  Filename of the medical image file. String or `pathlib.Path`
        Returns: 
            An instance of `cls`
        """
        if isinstance(fn, str):
            if fn.endswith('.npy'): fn = np.load(fn)
            else:
                array, metadata = TensorDicom3D.load(fn,load_header)
                instance = cls(array, metadata)

        if isinstance(fn,ndarray): instance = cls(fn)
        if isinstance(fn, Tensor): instance = cls(fn)
        return instance

    @staticmethod
    def load(fn: (Path, str), load_header:bool):
        """
        Loads a Medical image file. Stores pixel information as `Tensor` and DICOM header as dictionary. 
        Args: 
            fn:  Filename of the medical image file. String or `pathlib.Path`
            metadata_for_all_slices: if a DICOM series is given, if metadata from every single elemt of the series should be read. 
            
        Returns: 
            A tuple. 1st element is the pixelvalues converted to a `Tensor`, 2nd element is the metadata as dict. 
        Process:    
           [load pixel array] -> [load basic metadata] -> [load image header] -> [return]
    
            load pixel array: 
                Medical images can be presented as a single volumetric file or as a (DICOM)-series.
                If `fn` points to a directory, it is assumed that a DICOM series should be loaded. 
                If `fn` is a file, it is assumed it is a single 3D Volume. 
                
            load basic meta data: 
                Spacing, origin and direction are important for image display and calulations. 
                They are stored seperatly. 
                
            load image header (optional): 
                creates a dict with header information. 
                For most purposes, the header information is not needed, and just takes time to load. 
                Is thus turned off by default. 
                For multiple slices, header information for each slice is loaded.
                
                | tags      | fn_01                        | fn_02             | ...
                |-----------|------------------------------|-------------------|----
                | DICOM tag | name of file or of 1st slice | name of 2nd slice | ...
                
                Some tags contain special characters, which are transformed to surrogates. 
                This will lead to failure when displaying or writing the metadata. 
                Using encode(errors='ignore').decode() the surrogates are removed and the string ist turned into a bytes object.
                Using decode will turn the bytes back into a string.  
        """
        # Initialize metadata
        metadata = {'0008|103E': ['faimed3d TensorDicom3D, pixeldata might have been modified'], 
                    'filename' : [str(fn)]}
        
        
        # read volume
        if isinstance(fn, str): fn = Path(fn)
        if fn.is_dir(): 
            sitk.ProcessObject_SetGlobalDefaultThreader('PLATFORM')
            im = TensorDicom3D.read_dicom_series(str(fn))
        elif fn.is_file(): im = sitk.ReadImage(str(fn), outputPixelType=sitk.sitkFloat32)
        else: raise TypeError('the path "{}" is neither a valid directory nor a file'.format(str(fn)))
        # set basic metadata
        metadata['spacing'] = im.GetSpacing()
        metadata['origin'] = im.GetOrigin()
        metadata['direction'] = im.GetDirection()
        if load_header:
            if fn.is_dir():        
                metadata = TensorDicom3D.read_metadata_from_series(str(fn), metadata)
            if fn.is_file():            
                for k in im.GetMetaDataKeys():
                    metadata[k] = im.GetMetaData(k).encode(encoding='UTF-8',errors='ignore').decode() 
        return (torch.tensor(sitk.GetArrayFromImage(im)), metadata)
    
    @staticmethod
    def read_metadata_from_series(fn:str, metadata):
        "read metadata from file or Series and returns a pd.DataFrame"
        # iter through slices, collecting remaining metadata 
        SeriesReader = sitk.ImageSeriesReader()            
        dicom_names = SeriesReader.GetGDCMSeriesFileNames(str(fn))
        reader = sitk.ImageFileReader()
        reader.SetFileName(dicom_names[0])
        reader.ReadImageInformation()
        
        for dcm in dicom_names:
            reader.SetFileName(dcm)
            reader.ReadImageInformation()  
            for k in reader.GetMetaDataKeys():
                try: 
                    val = reader.GetMetaData(k).encode(encoding='UTF-8',errors='ignore').decode() 
                    if k not in metadata:  metadata[k] = [val] 
                    elif val not in metadata[k]: metadata[k].append(val)
                except: 
                    print('Failed loading metadata for {}'.format(fn))
        
        return metadata
        
    @staticmethod
    def read_dicom_series(fn:str):
        """load a DICOM series as 3D volume."""
        SeriesReader = sitk.ImageSeriesReader()            
        dicom_names = SeriesReader.GetGDCMSeriesFileNames(str(fn))
        SeriesReader.SetFileNames(dicom_names)
        im = SeriesReader.Execute()        
        return sitk.Cast(im, sitk.sitkFloat32)
        
    def as_sitk(self):
        "convertes Tensor to SimpleITK image"
        im = sitk.GetImageFromArray(self._t.detach().cpu().numpy())
       # also save metadata        
        im.SetSpacing(self._metadata['spacing'])
        im.SetDirection(self._metadata['direction'])
        im.SetOrigin(self._metadata['origin'])
        for k in self._metadata:
            try: im.SetMetaData(self._metadata[k][0], k)
            except: pass
        return im
        
    def save(self, fn:str):
        im = self.as_sitk()
        sitk.WriteImage(im, fn)

    def get_metadata(self, tag): return self._metadata[tag]
    
    def set_metadata(self, tag, value): self._metadata[tag]=value
        
    def metadata_to_json(self, metadata=None): 
        import json
        if metadata is none: metadata = self._metadata
        return json.dumps(metadata, indent = 4)

    def print_metadata(self, full = False): 
        for i, k in enumerate(self._metadata.keys()):
            if i < 5: print(k, ': \t', self._metadata[k])
            elif full: 
                print(k, ':')
                for i, val in enumerate(self._metadata[k]):              
                    print('\t', val)
                    if i == 2: 
                        print('\t (...)')
                        break
    
    def __getattribute__(self, attr):
        if attr != '_t' and hasattr(self._t, attr): 
            return object.__getattribute__(self._t, attr)
        else:
            return object.__getattribute__(self, attr)
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TensorMask3D" class="doc_header"><code>class</code> <code>TensorMask3D</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L198" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TensorMask3D</code>(<strong><code>x</code></strong>, <strong><code>metadata</code></strong>=<em><code>None</code></em>, <strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/faimed3d/basics.html#TensorDicom3D"><code>TensorDicom3D</code></a></p>
</blockquote>
<p>Base class for 3d Segmentation, inherits from TensorDicom3D</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;/media/ScaleOut/prostata/data/dcm/A0042197734/T2/DICOM/&#39;</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">TensorDicom3D</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">load_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">im</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">im2</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span> <span class="s1">&#39;_metadata&#39;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">im</span><span class="p">[</span><span class="n">im</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">im</span><span class="p">,</span> <span class="n">im2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-6-49659d4903b3&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> test_eq<span class="ansi-blue-fg">(</span>hasattr<span class="ansi-blue-fg">(</span>im<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;_metadata&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> test_eq<span class="ansi-blue-fg">(</span>hasattr<span class="ansi-blue-fg">(</span>im<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;_metadata&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg"> </span>test_eq<span class="ansi-blue-fg">(</span>hasattr<span class="ansi-blue-fg">(</span>im<span class="ansi-blue-fg">.</span>cuda<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;_metadata&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> im2 <span class="ansi-blue-fg">=</span> im
<span class="ansi-green-intense-fg ansi-bold">      5</span> test_eq<span class="ansi-blue-fg">(</span>hasattr<span class="ansi-blue-fg">(</span>im2<span class="ansi-blue-fg">.</span>cuda<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">&#39;_metadata&#39;</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/anaconda3/envs/fastai-v2/lib/python3.7/site-packages/fastai/torch_core.py</span> in <span class="ansi-cyan-fg">__torch_function__</span><span class="ansi-blue-fg">(self, func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    317</span> <span class="ansi-red-fg">#         if func.__name__[0]!=&#39;_&#39;: print(func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    318</span> <span class="ansi-red-fg">#         with torch._C.DisableTorchFunction(): ret = _convert(func(*args, **(kwargs or {})), self.__class__)</span>
<span class="ansi-green-fg">--&gt; 319</span><span class="ansi-red-fg">         </span>ret <span class="ansi-blue-fg">=</span> super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__torch_function__<span class="ansi-blue-fg">(</span>func<span class="ansi-blue-fg">,</span> types<span class="ansi-blue-fg">,</span> args<span class="ansi-blue-fg">=</span>args<span class="ansi-blue-fg">,</span> kwargs<span class="ansi-blue-fg">=</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    320</span>         <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">,</span> TensorBase<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> ret<span class="ansi-blue-fg">.</span>set_meta<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> as_copy<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    321</span>         <span class="ansi-green-fg">return</span> ret

<span class="ansi-green-fg">~/anaconda3/envs/fastai-v2/lib/python3.7/site-packages/torch/tensor.py</span> in <span class="ansi-cyan-fg">__torch_function__</span><span class="ansi-blue-fg">(cls, func, types, args, kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    993</span> 
<span class="ansi-green-intense-fg ansi-bold">    994</span>         <span class="ansi-green-fg">with</span> _C<span class="ansi-blue-fg">.</span>DisableTorchFunction<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">--&gt; 995</span><span class="ansi-red-fg">             </span>ret <span class="ansi-blue-fg">=</span> func<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    996</span>             <span class="ansi-green-fg">return</span> _convert<span class="ansi-blue-fg">(</span>ret<span class="ansi-blue-fg">,</span> cls<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    997</span> 

<span class="ansi-red-fg">RuntimeError</span>: CUDA error: out of memory</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Handlers-for-Metadata">Handlers for Metadata<a class="anchor-link" href="#Handlers-for-Metadata"> </a></h3><p>Some metadata needs to be modified, acessed more than other, so some wrapper functions are supplied.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.set_spacing" class="doc_header"><code>TensorDicom3D.set_spacing</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L205" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.set_spacing</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>spacing</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.set_spacing" class="doc_header"><code>TensorDicom3D.set_spacing</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L205" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.set_spacing</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>spacing</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.get_spacing" class="doc_header"><code>TensorDicom3D.get_spacing</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L211" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.get_spacing</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.get_spacing" class="doc_header"><code>TensorDicom3D.get_spacing</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L211" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.get_spacing</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.set_origin" class="doc_header"><code>TensorDicom3D.set_origin</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L214" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.set_origin</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>origin</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.set_origin" class="doc_header"><code>TensorDicom3D.set_origin</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L214" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.set_origin</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>origin</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.get_origin" class="doc_header"><code>TensorDicom3D.get_origin</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L220" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.get_origin</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.get_origin" class="doc_header"><code>TensorDicom3D.get_origin</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L220" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.get_origin</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.set_direction" class="doc_header"><code>TensorDicom3D.set_direction</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L223" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.set_direction</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>direction</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.set_direction" class="doc_header"><code>TensorDicom3D.set_direction</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L223" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.set_direction</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>direction</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.get_direction" class="doc_header"><code>TensorDicom3D.get_direction</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L229" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.get_direction</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.get_direction" class="doc_header"><code>TensorDicom3D.get_direction</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L229" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.get_direction</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Display-3D-images">Display 3D images<a class="anchor-link" href="#Display-3D-images"> </a></h2><p>Function to display the 3D volume in axial, coronal o</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="show_image_3d" class="doc_header"><code>show_image_3d</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L233" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>show_image_3d</code>(<strong><code>t</code></strong>:<code>Tensor'&gt;)</code>, <strong><code>axis</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>figsize</code></strong>:<code>int</code>=<em><code>(15, 15)</code></em>, <strong><code>cmap</code></strong>:<code>str</code>=<em><code>'bone'</code></em>, <strong><code>nrow</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>alpha</code></strong>=<em><code>1.0</code></em>, <strong><code>return_grid</code></strong>=<em><code>False</code></em>, <strong><code>add_to_existing</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Plots 2D slices of a 3D image alongside a prior specified axis.
Args:
    t: a 3D numpy.ndarray or torch.Tensor
    axis: axis to split 3D array to 2D images
    figsize, cmap: passed to plt.imshow
    nrow: passed to torchvision.utils.make_grid
    return_grid: Whether the grid should be returned for further processing or if the plot should be displayed.
    add_to_existing: if set to true, no new figure will be created. Used for mask overlays</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_image_3d</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Sometimes multiple 3D images (e.g. a batch) need to be displayed. With a wrapper for <a href="/faimed3d/basics.html#show_image_3d"><code>show_image_3d</code></a> this is conveniently possible.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="show_images_3d" class="doc_header"><code>show_images_3d</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L272" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>show_images_3d</code>(<strong><code>t</code></strong>:<code>Tensor</code>, <strong><code>axis</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>figsize</code></strong>:<code>int</code>=<em><code>(15, 15)</code></em>, <strong><code>cmap</code></strong>:<code>str</code>=<em><code>'bone'</code></em>, <strong><code>nrow</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>alpha</code></strong>=<em><code>1.0</code></em>, <strong><code>return_grid</code></strong>=<em><code>False</code></em>, <strong><code>add_to_existing</code></strong>=<em><code>False</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Displays multiple 3D images (e.g. a batch) by flattening the 4th dimension of the tensor
and then calling show_image_3d
Args:
    t (torch.Tensor): input image with dimension B x D x H x W or B x C x D x H x W,
                      however C is ignored for display
    axis (int): Axis to split images to multiple 2D slices. <a href="/faimed3d/basics.html#show_images_3d"><code>show_images_3d</code></a> does not
                know about pixel spacing, so choosing a non-standard axis will result in
                atypical looking images.
    figsize, cmap, nrow, alpha: passed to plot function
    return_grid (bool): return the grid, not the plot for further processing
    add_to_existing (bool): adds plot to existing plot, not calling plot.new.
                            Usefull for overlays, e.g. with masks.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">show_images_3d</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">im</span><span class="p">,</span><span class="n">im</span><span class="p">)),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span> <span class="c1"># for compatibility with show_docs</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Tensor.show" class="doc_header"><code>Tensor.show</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L313" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Tensor.show</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>axis</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>figsize</code></strong>:<code>int</code>=<em><code>(15, 15)</code></em>, <strong><code>cmap</code></strong>:<code>str</code>=<em><code>'bone'</code></em>, <strong><code>nrow</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>displays the 3D image as a mosaik</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.show" class="doc_header"><code>TensorDicom3D.show</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L313" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.show</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>axis</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>figsize</code></strong>:<code>int</code>=<em><code>(15, 15)</code></em>, <strong><code>cmap</code></strong>:<code>str</code>=<em><code>'bone'</code></em>, <strong><code>nrow</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>displays the 3D image as a mosaik</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.show" class="doc_header"><code>TensorDicom3D.show</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L313" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.show</code>(<strong><code>t</code></strong>:<code>TensorMask3D'&gt;)</code>, <strong><code>axis</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>figsize</code></strong>:<code>int</code>=<em><code>(15, 15)</code></em>, <strong><code>cmap</code></strong>:<code>str</code>=<em><code>'bone'</code></em>, <strong><code>nrow</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>displays the 3D image as a mosaik</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Rendering-3D-Objects">Rendering 3D Objects<a class="anchor-link" href="#Rendering-3D-Objects"> </a></h1><p>Somtimes the mask is better viewed as 3D object. Rendering is implemented as described in this example: <a href="https://scikit-image.org/docs/dev/auto_examples/edges/plot_marching_cubes.html">https://scikit-image.org/docs/dev/auto_examples/edges/plot_marching_cubes.html</a>
A faster, more felxible way might be using <a href="https://github.com/maartenbreddels/ipyvolume/">ipyvolume</a> or <a href="https://pyscience.wordpress.com/2014/09/11/surface-extraction-creating-a-mesh-from-pixel-data-using-python-and-vtk/">vtk</a>.</p>
<p>To implement 3D rendering for the mask, the TensorMask3D class needs to be expanded</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.strip" class="doc_header"><code>TensorDicom3D.strip</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L332" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.strip</code>(<strong><code>x</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="TensorDicom3D.strip" class="doc_header"><code>TensorDicom3D.strip</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L332" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>TensorDicom3D.strip</code>(<strong><code>x</code></strong>:<code>TensorMask3D'&gt;)</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TensorMask3D" class="doc_header"><code>class</code> <code>TensorMask3D</code><a href="https://github.com/kbressem/faimed3d/tree/master/faimed3d/basics.py#L198" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TensorMask3D</code>(<strong><code>x</code></strong>, <strong><code>metadata</code></strong>=<em><code>None</code></em>, <strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/faimed3d/basics.html#TensorDicom3D"><code>TensorDicom3D</code></a></p>
</blockquote>
<p>Base class for 3d Segmentation, inherits from TensorDicom3D</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im</span>  <span class="o">=</span> <span class="n">TensorMask3D</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;/media/ScaleOut/prostata/data/dcm/A0042197734/T2/Annotation/Annotation.nii.gz&#39;</span><span class="p">)</span>       
<span class="n">im</span><span class="o">.</span><span class="n">render_3d</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">im</span><span class="o">.</span><span class="n">calc_volume</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

